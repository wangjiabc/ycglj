<!DOCTYPE html>
<html>

<head>
	<title>添加位置照片信息</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<meta charset="utf-8" />
	<link rel="stylesheet" href="css/weui.css" />
	<link rel="stylesheet" href="css/example.css" />
	<link rel="stylesheet" href="css/jquery-weui.css">
	<link rel="stylesheet" href="../../asset/css/icon.css">
	<style type="text/css">
		body,
		html,
		#allmap {
			width: 100%;
			height: 70%;
			margin: 0;
			font-family: "微软雅黑";
		}

		.current {
			opacity: 0.4;
		}

		.weui-flex {
			padding: 10px;
		}

		.page-bd li {
			background-color: #fff;
			border-radius: 2px;
			cursor: pointer;
			margin: 10px 0;
			overflow: hidden;
			vertical-align: bottom;
			display: block;
		}

		.page-bd li.js-show .weui-flex {
			opacity: 0.4;
		}

		.page-bd li.js-show .page-category {
			height: auto;
		}

		.page-bd li.js-show .page-category-content {
			opacity: 1;
			transform: translateY(0px);
		}

		.page-bd li:first-child {
			margin-top: 0;
		}

		.page-bd .page-category {
			height: 0;
			overflow: hidden;
		}

		.page-bd .page-category-content {
			opacity: 0;
			transform: translateY(-50%);
			transition: 0.3s;
		}

		.page-bd .weui-flex {

			align-items: center;
			padding: 10px;
			transition: all 0.3s ease 0s;
			display: -webkit-flex;
			display: -webkit-box;
			display: flex;
		}

		.page-bd .weui-flex--item {
			-webkit-flex: 1 1 0;
			flex: 1 1 0;
		}

		.page-bd .weui-cells {
			margin-top: 0;
		}
	</style>

</head>

<body>
	<form action="" novalidate>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">地址</label></div>
				<div id="address" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">姓名</label></div>
				<div id="name" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">手机号</label></div>
				<div id="phone" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">许可证号</label></div>
				<div id="license" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">身份证号</label></div>
				<div id="idcard" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">所属中队</label></div>
				<div id="region" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">日期</label></div>
				<div id="datetime" class="weui-cell__bd">
				</div>
			</div>
		</div>
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">业态</label></div>
				<div id="business_status" class="weui-cell__bd">
				</div>
			</div>
		</div>

		<div class="weui-cells weui-cells_form menu_list">
			<!-- <div id="crimal" class="weui-cell weui-cell_access"> -->
			<div class="weui-flex current">
				<div class="weui-flex__item">案由</div>
				<p style="display:none;margin-right: 10px">暂无</p>
				<i class="icon icon-74"></i>
			</div>

			<!-- </div> -->
		</div>

		<div class="weui-cells weui-cells_form">
			<div class="weui-cell weui-cell_switch">
				<div class="weui-cell__bd">是否重点检查</div>
				<div class="weui-cell__ft">
					<input class="weui-switch" id="check" type="checkbox">
				</div>
			</div>
		</div>


		<div class="weui-cells weui-cells_form">
			<div class="weui-cell weui-cell_access" onclick="clickEvent();">
				<div class="weui-cell__hd"><label class="weui-label">案件录入</label></div>
				<div id="ay" class="weui-cell__bd">
				</div>
				<div class="weui-cell__ft"></div>
			</div>
		</div>

	</form>

	<div class="weui-cells weui-cells_form">
	</div>

	<div class="weui-cell weui-cell_access">
		<div class="weui-cell__bd">零售户位置</div>
		<div class="weui-cell__ft" style="font-size: 0">
			<span id="navigation" class="weui-btn weui-btn_mini weui-btn_primary">导航路线</span>
		</div>
	</div>
	<div id="allmap"></div>

	<div class="weui-panel weui-panel_access">
		<div class="weui-panel__hd">零售户图片</div>
		<div id="img" class="weui-panel__bd">
		</div>
	</div>

	<div class="weui-panel weui-panel_access">
		<div class="weui-panel__hd">许可证图片</div>
		<div id="img2" class="weui-panel__bd">
		</div>
	</div>

	<div class="weui-panel weui-panel_access">
		<div class="weui-uploader__input-box" id="showPicker">
		</div>
	</div>

</body>

</html>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=cR98TwX2FnKTpANIOYhMYMot9a4ioxjc"></script>
<script type="text/javascript" src="https://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script src="../../../js/jquery-weui.js"></script>
<script type="text/javascript">
	function getQueryString(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
		var r = window.location.search.substr(1).match(reg);
		if (r != null) return unescape(r[2]); return null;
	}

	var license = getQueryString("license");

	// 百度地图API功能
	var map = new BMap.Map("allmap");    // 创建Map实例

	var longitude = getQueryString("longitude");
	var latitude = getQueryString("latitude");
	var point = new BMap.Point(longitude, latitude);

	var pointStart = point;

	var str = "我的位置";
	var opts = {
		position: point,    // 指定文本标注所在的地理位置
		offset: new BMap.Size(-getByteLen(str) * 3, 5)    //设置文本偏移量
	}
	var label = new BMap.Label(str, opts);  // 创建文本标注对象
	label.setStyle({
		fontSize: "12px",
		height: "20px",
		lineHeight: "20px",
		fontFamily: "微软雅黑"
	});
	map.addOverlay(label);

	function keyDown(e) {
		var keycode = e.which;   //取得对应的键值（数字）  	  
		var realkey = String.fromCharCode(e.which); //取得代表改键的真正字符  
		var val = document.getElementById("input").value;
		if (keycode == 13) {
			local.search(val);
		}
	}

	$('#check').click(function () {
		// console.log($('#check').checked);
		var state;
		if ($('#check').prop('checked')) {
			console.log('1');
			state=1;
		} else {
			console.log('2');
			state=0;
		}
		
		$.get("../../user/updateWeight.do", {
			license: license,
			state : state,
			lng: longitude,
			lat: latitude
		}, function (data) {
		
			if(data<1){
				alert("操作失败");
			}
			
		});
		
	})
	
	function init(data) {
		console.log(data);
		$('#address').html(data.roomInfo.address);
		$('#name').html(data.roomInfo.name);
		if (data.roomInfo.weight == 1) {
			 $('#check').prop("checked", "true");			
		}

		if (data.crimal != null && data.crimal != "") {
			for (let index = 0; index < data.lawCases.length; index++) {
				var html = ' <div style="display:none weui-cells" class="weui-panel menu_body">' +
					'<div class="weui-panel__bd">' +
					'<div class="weui-media-box weui-media-box_text">' +
					'<h4 class="weui-media-box__title">' + "录入人 : " + data.lawCases[index].user_name + '</h4>' +
					'<p class="weui-media-box__desc" style="color:red">' + data.lawCases[index].criminal_content + '</p>' +
					'<ul class="weui-media-box__info">' +
					'<li class="weui-media-box__info__meta">' + "录入时间 : " + actionTime(data.lawCases[index].criminal_time) + '</li>' +
					'</ul>' +
					'</div>' +
					'</div>'
				$('.menu_list').append(html);
			}
		} else {
			$('.weui-flex p').css('display', 'block');
			// var hidden = document.createElement("div");
			// hidden.setAttribute("class", "weui-cell__bd");
			// var span1 = document.createElement("span");
			// span1.setAttribute("style", "vertical-align: middle");
			// span1.innerHTML = "案由";
			// var span2 = document.createElement("span");
			// span2.setAttribute("style", "margin-left: 15px;");
			// span2.innerHTML = "无";
			// hidden.appendChild(span1);
			// hidden.appendChild(span2);
			// $("#crimal").append(hidden);
		}
		$("div.weui-flex").click(function () {
			// $("div.menu_body").slideToggle(300).siblings("div.menu_body").slideUp("slow");
			$(this).siblings('div.menu_body').slideToggle(300);
			if ($(this).hasClass('current')) {
				$(this).removeClass('current');
				$(this).children('i').removeClass('icon-74').addClass('icon-35');
			} else {
				$(this).siblings().removeClass('current');
				$(this).addClass('current');
				$(this).children('i').removeClass('icon-35').addClass('icon-74');
				$(this).siblings().find('i').removeClass('icon-74').addClass('icon-35');
			}

		});
		if (data.roomInfo.phone != null && data.roomInfo.phone != "") {
			var phone = document.createElement("a");
			phone.setAttribute("href", "tel:" + data.roomInfo.phone);
			phone.innerHTML = data.roomInfo.phone;
			$("#phone").append(phone);
		} else {
			$("#phone_div").hide();
		}

		$('#license').html(data.roomInfo.license);
		$('#datetime').html(actionTime(data.roomInfo.date));
		$('#business_status').html(data.roomInfo.business_state);
		$('#idcard').html(data.roomInfo.id_number);
		$('#region').html(data.roomInfo.region);
		if (data.fileBytes != null) {
			var imgs = data.fileBytes;
			var i = 0;
			for (; i < imgs.length; i++) {
				var text = imgs[i];
				var name = text.fileBelong;
				var uri = text.compressUri;
				var panel = document.createElement("div");
				panel.setAttribute("class", "weui-panel__bd");
				var a = document.createElement("a");
				a.setAttribute("class", "weui_grid");
				var a = document.createElement("a");
				a.setAttribute("href", "javascript:void(0);");
				a.setAttribute("class", "weui-media-box weui-media-box_appmsg");
				var div = document.createElement("div");
				div.setAttribute("class", "weui-media-box__hd");

				src = "/ycglj/" + uri;
				var img = document.createElement("img");
				img.setAttribute("class", "weui-media-box__thumb");
				img.setAttribute("src", src);

				div.appendChild(img);

				div2 = document.createElement("div");
				div2.setAttribute("class", "weui-media-box__bd");
				h4 = document.createElement("h4");
				h4.setAttribute("class", "weui-media-box__title");
				p = document.createElement("p");
				p.setAttribute("class", "weui-media-box__desc");
				p.innerHTML = name;
				div2.appendChild(h4);
				div2.appendChild(p);
				a.appendChild(div);
				a.appendChild(div2);
				panel.appendChild(a);
				$("#img").append(panel);
			}

		}

		if (data.fileBytes2 != null) {
			var imgs = data.fileBytes2;
			var i = 0;
			for (; i < imgs.length; i++) {
				var text = imgs[i];
				var name = showdataType(text.dataType);
				var uri = text.compressUri;
				var panel = document.createElement("div");
				panel.setAttribute("class", "weui-panel__bd");
				var a = document.createElement("a");
				a.setAttribute("class", "weui_grid");
				var a = document.createElement("a");
				a.setAttribute("href", "javascript:void(0);");
				a.setAttribute("class", "weui-media-box weui-media-box_appmsg");
				var div = document.createElement("div");
				div.setAttribute("class", "weui-media-box__hd");

				src = "/ycglj/" + uri;
				var img = document.createElement("img");
				img.setAttribute("class", "weui-media-box__thumb");
				img.setAttribute("src", src);

				div.appendChild(img);

				div2 = document.createElement("div");
				div2.setAttribute("class", "weui-media-box__bd");
				h4 = document.createElement("h4");
				h4.setAttribute("class", "weui-media-box__title");
				p = document.createElement("p");
				p.setAttribute("class", "weui-media-box__desc");
				p.innerHTML = name;
				div2.appendChild(h4);
				div2.appendChild(p);
				a.appendChild(div);
				a.appendChild(div2);
				panel.appendChild(a);
				$("#img2").append(panel);
			}

		}

	}


	function clickEvent() {
		location.href = "case_entry.html?license=" + license + "&latitude=" + latitude + "&longitude=" + longitude;
	}

	function showdataType(type) {
		switch (type) {
			case 'identity':
				return '身份证正面照';
				break;
			case 'conIdentity':
				return '身份证反面照';
				break;
			case 'business':
				return '工商营业执照';
				break;
			case 'license':
				return '营业许可证';
				break;
			case 'sing':
				return '签名照';
				break;
			case 'other':
				return '其它';
				break;
		}
	}
	if (license == null) {

	} else {
		$.ajax({
			type: "POST",
			url: "../../user/getRoomInfoByGUID.do",
			data: {
				"license": license
			},
			dataType: "json",
			error: function (request) {
				console.log(request);
			},
			success: function (text) {
				var obj = text.roomInfo;
				var license = obj.license;
				init(text);
				var distance = null;
				console.log(obj.name + "   " + obj.detail + "  " + obj.lng + "   "
					+ obj.lat);
				if (obj.lng != "" && obj.lat != "") {
					distance = getDistance(obj.lng, obj.lat);
					addPoint(obj.lng, obj.lat);
				}

				if (obj.wgs84_lng != "" && obj.wgs84_lat != "") {
					$("#navigation").on(
						"click",
						function () {
							wechatLat = wgs84togcj02(obj.wgs84_lng, obj.wgs84_lat).lat;
							wechatLng = wgs84togcj02(obj.wgs84_lng, obj.wgs84_lat).lng;
							console.log(wechatLat, wechatLng);
							wx.openLocation({
								latitude: wechatLat, // 纬度，浮点数，范围为90 ~ -90
								longitude: wechatLng, // 经度，浮点数，范围为180 ~ -180。
								name: '零售商户地理位置', // 位置名
								address: '', // 地址详情说明
								scale: 14, // 地图缩放级别,整形值,范围从1~28。默认为最大
								infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
							});
						});
				} else {
					$("#navigation").hide();
				}

				var chartlicense = encodeURI(obj.chartlicense);
				$("#State").click(
					function () {
						location.href = "assetState.html?chartlicense="
							+ chartlicense + "&latitude=" + latitude
							+ "&longitude=" + longitude;
					});
			}
		});
	}

	function addPoint(lng, lat) {
		var point = new BMap.Point(lng, lat);
		var pointEnd = point;
		map.centerAndZoom(point, 12);
		var myIcon = new BMap.Icon("../../img/blackPoint.jpg",
			new BMap.Size(30, 38));
		var marker = new BMap.Marker(point); // 创建点
		map.addOverlay(marker); //增加点
		var geolocationControl = new BMap.GeolocationControl();
		map.addControl(geolocationControl);
		marker.enableDragging(); //标注可拖拽
		// 定义一个控件类,即function
		function ZoomControl() {
			// 默认停靠位置和偏移量
			this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
			this.defaultOffset = new BMap.Size(10, 10);
		}

		// 通过JavaScript的prototype属性继承于BMap.Control
		ZoomControl.prototype = new BMap.Control();

		// 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
		// 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
		ZoomControl.prototype.initialize = function (map) {
			// 创建一个DOM元素
			var img = document.createElement("img");
			img.src = "../../asset/images/max.png";
			// 绑定事件,点击一次放大两级
			img.onclick = function (e) {
				map.setZoom(17);
			}
			// 添加DOM元素到地图中
			map.getContainer().appendChild(img);
			// 将DOM元素返回
			return img;
		}
		// 创建控件
		var myZoomCtrl = new ZoomControl();
		// 添加到地图当中
		map.addControl(myZoomCtrl);
		// 开启事件监听
		marker.addEventListener("dragend", function (e) {

			var clng = e.point.lng; //经度
			var clat = e.point.lat; //纬度
			var bMap = bMapTransWechatMap(clng, clat);
			var gcj02 = gcj02towgs84(bMap.lng, bMap.lat);
			var wgs84_lng = gcj02.lng;
			var wgs84_lat = gcj02.lat;
			$.confirm({
				title: '提示',
				text: '是否修改零售户到当前位置?',
				onOK: function () {
					//点击确认

					var geoc = new BMap.Geocoder();

					geoc.getLocation(point, function (rs) {
						var addComp;
						addComp = rs.addressComponents;
						var addComp1 = JSON.stringify(addComp);
						var url = "../../user/manualUpdatePosition.do";
						$.get(url, {
							license: license,
							lng: clng,
							lat: clat,
							addComp: addComp1,
							wgs84_lng: wgs84_lng,
							wgs84_lat: wgs84_lat
						}, function (data) {
							console.log(data);
							if (data == 1) {
								$.get("../../user/findPositionByLicense.do", {
									license: license
								}, function (text) {
									var data = JSON.parse(text);
									map.clearOverlays();
									addPoint(data.lng, data.lat);
								});
							} else {

								alert("修改位置失败");
								map.clearOverlays();
								addPoint(lng, lat);
							}
						});
					});

				},
				onCancel: function () {

					$.get("../../user/findPositionByLicense.do", {
						license: license
					}, function (text) {
						var data = JSON.parse(text);
						map.clearOverlays();
						addPoint(data.lng, data.lat);
					});

				}
			});

		});
	}

	/**
	 * WGS84转GCj02
	 * @param lng
	 * @param lat
	 * @returns {*[]}
	 */
	function wgs84togcj02(lng, lat) {
		var PI = 3.1415926535897932384626;
		var a = 6378245.0;
		var ee = 0.00669342162296594323;
		var dlat = transformlat(lng - 105.0, lat - 35.0);
		var dlng = transformlng(lng - 105.0, lat - 35.0);
		var radlat = lat / 180.0 * PI;
		var magic = Math.sin(radlat);
		magic = 1 - ee * magic * magic;
		var sqrtmagic = Math.sqrt(magic);
		dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
		dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
		var mglat = lat + dlat;
		var mglng = lng + dlng;
		return { lng: mglng, lat: mglat };
	}

	function transformlat(lng, lat) {
		var PI = 3.1415926535897932384626;
		var ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
		ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
		ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
		ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
		return ret
	}

	function transformlng(lng, lat) {
		var PI = 3.1415926535897932384626;
		var ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
		ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
		ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
		ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
		return ret
	}

	//百度地图转换微信地图经纬度
	function bMapTransWechatMap(lng, lat) {
		var PI = 3.1415926535897932384626;
		let x_pi = PI * 3000.0 / 180.0;
		let x = lng - 0.0065; let y = lat - 0.006;
		let z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_pi);
		let theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_pi);
		let lngs = z * Math.cos(theta);
		let lats = z * Math.sin(theta);
		return { lng: lngs, lat: lats };
	}

	/**
	 * GCJ02 转换为 WGS84
	 * @param lng
	 * @param lat
	 * @returns {*[]}
	 */
	function gcj02towgs84(lng, lat) {
		var PI = 3.1415926535897932384626;
		var a = 6378245.0;
		var ee = 0.00669342162296594323;
		var dlat = transformlat(lng - 105.0, lat - 35.0);
		var dlng = transformlng(lng - 105.0, lat - 35.0);
		var radlat = lat / 180.0 * PI;
		var magic = Math.sin(radlat);
		magic = 1 - ee * magic * magic;
		var sqrtmagic = Math.sqrt(magic);
		dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
		dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
		mglat = lat + dlat;
		mglng = lng + dlng;
		return { lng: lng * 2 - mglng, lat: lat * 2 - mglat };
	}

	//线路
	function navigation(p1, p2) {
		var points = [p1, p2];
		var curve = new BMapLib.CurveLine(points, {
			strokeColor: "blue",
			strokeWeight: 2,
			strokeOpacity: 0.5
		});
		map.addOverlay(curve);
	}

	function actionTime(value) {
		var date = new Date(value);
		Y = date.getFullYear() + '年';
		M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date
			.getMonth() + 1)
			+ '月';
		D = date.getDate() + '日 ';
		h = date.getHours() + ':';
		m = date.getMinutes() + ':';
		s = date.getSeconds();
		return Y + M + D;
	}


	function getByteLen(val) { //传入一个字符串
		var len = 0;
		for (var i = 0; i < val.length; i++) {
			if (val[i].match(/[^\x00-\xff]/ig) != null) //全角 
				len += 2; //如果是全角，占用两个字节  如果mysql中某字段是text, 如果设置编码为utf-8,那么一个中文是占3个字节, gbk是两个字节
			else
				len += 1; //半角占用一个字节
		}
		return len;
	}

	function getDistance(lng, lat) {
		var pointA = new BMap.Point(longitude, latitude); // 创建点坐标A--大渡口区
		var pointB = new BMap.Point(lng, lat); // 创建点坐标B--江北区
		var d = map.getDistance(pointA, pointB) / 1000;
		return d.toFixed(2) + ' KM'; //获取两点距离,保留小数点后两位
	}

	url = document.location.toString();

	$.ajax({
		url: "../../../wechat/sign.do",
		data: {
			campusId: 1,
			url: url
		},
		async: false,
		type: "GET",
		success: function (data) {
			var ticket = JSON.parse(data);

			wx.config({
				debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
				appId: ticket.appId,
				timestamp: ticket.timestamp,
				nonceStr: ticket.nonceStr,
				signature: ticket.signature,
				jsApiList: ['checkJsApi', 'onMenuShareTimeline',
					'onMenuShareAppMessage', 'onMenuShareQQ',
					'onMenuShareWeibo', 'hideMenuItems', 'showMenuItems',
					'hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem',
					'translateVoice', 'startRecord', 'stopRecord',
					'onRecordEnd', 'playVoice', 'pauseVoice', 'stopVoice',
					'uploadVoice', 'downloadVoice', 'chooseImage',
					'previewImage', 'uploadImage', 'downloadImage',
					'getNetworkType', 'openLocation', 'getLocation',
					'hideOptionMenu', 'showOptionMenu', 'closeWindow',
					'scanQRCode', 'chooseWXPay', 'openProductSpecificView',
					'addCard', 'chooseCard', 'openCard']
			});

			var images = {
				localId: [],
				serverId: []
			};

			document.querySelector('#showPicker').onclick = function () {

				var imagename = "无标题";



				wx.getLocation({
					type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
					success: function (res) {
						var wgs84_lat = res.latitude; // 纬度，浮点数，范围为90 ~ -90
						var wgs84_lng = res.longitude; // 经度，浮点数，范围为180 ~ -180。
						var speed = res.speed; // 速度，以米/每秒计
						var accuracy = res.accuracy; // 位置精度
						$.get("/ycglj/mobile/map/baiduSwitch.do", { //微信地理位置坐标转换成百度地图坐标
							longitude: wgs84_lng,
							latitude: wgs84_lat
						}, function (text) {
							var obj = $.parseJSON(text);
							var result = obj.result;
							var lat = result[0].y;
							var lng = result[0].x;

							$.modal({
								title: "选择上传图片类型",
								text: '<div class="weui-cell weui-cell_select weui-cell_select-after">' +
									'<div class="weui-cell__bd">' +
									'<select class="weui-select" id="select" name="select2">' +
									'<option value="1">零售户照片</option>' +
									' <option value="2">许可证号</option>' +
									' <option value="3">身份证正面</option>' +
									' <option value="4">身份证反面</option>' +
									' <option value="5">营业扏照</option>' +
									' <option value="6">其他</option>' +
									' </select>' +
									'</div>' +
									'</div>',
								buttons: [
									{
										text: "确定", onClick: function () {

											var objS = document.getElementById("select");
											var grade = objS.options[objS.selectedIndex].value;
											var classType;
											if (grade == 1) {
												classType = "User_License";
											} else if (grade == 2) {
												classType = "license";
											} else if (grade == 3) {
												classType = "identity";
											} else if (grade == 4) {
												classType = "conIdentity";
											} else if (grade == 5) {
												classType = "business";
											} else if (grade == 6) {
												classType = "other";
											}
											upImage(classType);
										}
									},
									{ text: "取消", className: "default", onClick: function () { console.log(3) } },
								]
							});

							function upImage(classType) {
								wx.chooseImage({
									success: function (res) {
										images.localId = res.localIds;
										console.log('已选择 ' + res.localIds.length
											+ ' 张图片');
										var i = 0, length = images.localId.length;
										images.serverId = [];
										function upload(classType) {
											wx.uploadImage({
												localId: images.localId[i].toString(),
												isShowProgressTips: images.localId[i]
													.toString(),
												success: function (res) {
													i++;
													console.log('已上传：' + i + '/'
														+ length);
													//返回图片的服务器端ID res.serverId,然后调用wxImgCallback函数进行下载图片操作
													wxImgCallback(imagename, res.serverId, classType,
														lng, lat, wgs84_lng, wgs84_lat);
													if (i < length) {
														upload(classType);
													}
												},
												fail: function (res) {
													console.log(res);
												}
											});
										}
										upload(classType);
									}
								});
							}

						});
					}
				});


			}

		}
	});

	var geoc = new BMap.Geocoder();

	function wxImgCallback(imagename, serverId, classType, lng, lat, wgs84_lng, wgs84_lat) {
		//将serverId传给wx_upload.php的upload方法
		var url = "../../user/updatePositionByRoomInfo.do";
		geoc.getLocation(point, function (rs) {
			var addComp;
			addComp = rs.addressComponents;
			var addComp1 = JSON.stringify(addComp);
			var url = "../../user/updatePositionByRoomInfo.do";
			$.get(url, {
				campusId: 1,
				imagename: imagename,
				serverId: serverId,
				id: license,
				classType: classType,
				license: license,
				lng: lng,
				lat: lat,
				addComp: addComp1,
				wgs84_lng: wgs84_lng,
				wgs84_lat: wgs84_lat
			}, function (data) {
				console.log(data);
				if (data == 0) {
					alert("上传图片失败!");
					console.log(data.msg);
				} else if (data == 1) {

					location.reload();

				}
			});
		});
	}
</script>


<script src="../../../js/previewImage.min.js"></script>

<script>

	var im = {};
	/**
	 * 得到多个元素
	 * @public
	 */
	im.all = function (selector, contextElement) {
		var nodeList,
			list = [];
		if (contextElement) {
			nodeList = contextElement.querySelectorAll(selector);
		} else {
			nodeList = document.querySelectorAll(selector);
		}
		if (nodeList && nodeList.length > 0) {
			list = Array.prototype.slice.call(nodeList);
		}
		return list;
	}

	/**
	 * 将事件委托给父元素
	 * @public
	 * @param  array     $el         父元素
	 * @param  string    eventType  事件类型名称
	 * @param  string    selector   目标的选择器
	 * @param  function  fn
	 */
	im.delegate = function ($el, eventType, selector, fn) {
		if (!$el) { return; }
		$el.addEventListener(eventType, function (e) {
			var targets = im.all(selector, $el);
			if (!targets) {
				return;
			}
			// findTarget:
			for (var i = 0; i < targets.length; i++) {
				var $node = e.target;
				while ($node) {
					if ($node == targets[i]) {
						fn.call($node, e);
						break; //findTarget;
					}
					$node = $node.parentNode;
					if ($node == $el) {
						break;
					}
				}
			}
		}, false);
	};


	im.delegate(document.querySelector('#img'), 'click', 'img', function () {

		var urls = [];
		var imgs = im.all('img', im.all('#img')[0]);
		imgs.forEach(function (v, i) {
			var str = v.src;
			var url = str.replace(/\/compressFile/, "");
			urls.push(url);
		})

		var thisStr = this.src;
		var current = thisStr.replace(/\/compressFile/, "");
		console.log(current);
		var obj = {
			urls: urls,
			current: current
		};
		previewImage.start(obj);
	});

	var im2 = {};
	/**
	 * 得到多个元素
	 * @public
	 */
	im2.all = function (selector, contextElement) {
		var nodeList,
			list = [];
		if (contextElement) {
			nodeList = contextElement.querySelectorAll(selector);
		} else {
			nodeList = document.querySelectorAll(selector);
		}
		if (nodeList && nodeList.length > 0) {
			list = Array.prototype.slice.call(nodeList);
		}
		return list;
	}

	/**
	 * 将事件委托给父元素
	 * @public
	 * @param  array     $el         父元素
	 * @param  string    eventType  事件类型名称
	 * @param  string    selector   目标的选择器
	 * @param  function  fn
	 */
	im2.delegate = function ($el, eventType, selector, fn) {
		if (!$el) { return; }
		$el.addEventListener(eventType, function (e) {
			var targets = im2.all(selector, $el);
			if (!targets) {
				return;
			}
			// findTarget:
			for (var i = 0; i < targets.length; i++) {
				var $node = e.target;
				while ($node) {
					if ($node == targets[i]) {
						fn.call($node, e);
						break; //findTarget;
					}
					$node = $node.parentNode;
					if ($node == $el) {
						break;
					}
				}
			}
		}, false);
	};


	im2.delegate(document.querySelector('#img2'), 'click', 'img', function () {

		var urls = [];
		var imgs = im2.all('img', im2.all('#img2')[0]);
		imgs.forEach(function (v, i) {
			var str = v.src;
			var url = str.replace(/\/compressFile/, "");
			urls.push(url);
		})

		var thisStr = this.src;
		var current = thisStr.replace(/\/compressFile/, "");
		console.log(current);
		var obj = {
			urls: urls,
			current: current
		};
		previewImage.start(obj);
	});

</script>